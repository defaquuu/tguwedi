name: 💬 Telegram Notifications

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/SimpleApp'

jobs:
  # Джоба 1: Сборка проекта с уведомлениями
  build-and-notify:
    name: 💡 Сборка и уведомления
    runs-on: ubuntu-latest
    
    steps:
    - name: 💡 Загружаем код
      uses: actions/checkout@v4
      
    - name: 💡 Устанавливаем .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: 💡 Уведомляем о начале сборки
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          **🚀 НАЧАЛО СБОРКИ!**
          
          📁 *Проект:* ${{ github.repository }}
          👤 *Автор:* ${{ github.actor }}
          🌿 *Ветка:* ${{ github.ref_name }}
          🔑 *Коммит:* ${GITHUB_SHA:0:7}
          
          ⏳ Сборка началась...
        parse_mode: markdown
        disable_web_page_preview: true
        
    - name: 💡 Восстанавливаем зависимости
      run: dotnet restore ./${{ env.PROJECT_PATH }}
      
    - name: 💡 Собираем проект
      run: dotnet build ./${{ env.PROJECT_PATH }} --configuration Release --no-restore
      
    - name: 📨 Отправляем итоговое уведомление
      if: always()
      uses: appleboy/telegram-action@master
      with:
        to: ${{ secrets.TELEGRAM_CHAT_ID }}
        token: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        message: |
          @if (success())
          {
            *✅ СБОРКА УСПЕШНО ЗАВЕРШЕНА!*
            
            Все этапы пройдены успешно!
            
            📊 *Результаты:*
            • Восстановление зависимостей: ✅
            • Компиляция проекта: ✅
            
            🎯 *Детали сборки:*
            • Проект: ${{ github.repository }}
            • Ветка: ${{ github.ref_name }}
            • Коммит: $(GITHUB_SHA:0:7)
            • Время: $(date +"%H:%M:%S")
            
            [📋 Открыть логи в GitHub](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          }
          @if (failure())
          {
            *❌ СБОРКА ПРОВАЛЕНА!*
            
            Что-то пошло не так...
            
            🔍 *Рекомендации:*
            1. Проверьте логи сборки
            2. Убедитесь, что все файлы на месте
            3. Проверьте зависимости проекта
            
            📊 *Статус:* ${{ job.status }}
            🕒 *Время:* $(date +"%H:%M:%S")
            
            [🔧 Открыть логи для отладки](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
          }
          @if (cancelled())
          {
            *⚠️ СБОРКА ОТМЕНЕНА*
            
            Процесс был прерван.
            
            ℹ️ *Возможные причины:*
            • Ручная отмена
            • Таймаут
            • Ошибка системы
            
            📊 *Статус:* ${{ job.status }}
          }
        parse_mode: markdown
        disable_web_page_preview: true